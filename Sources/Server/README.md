# How to 'server.py'?

## Что сейчас умеет сервер

Сервер умеет отдавать студентам курс, скиллпак и их прогресс

Сервер умеет отдавать менторам прогресс их студентов. (Всех поздравляю! с этого момента у разных менторов могут быть разные студенты!)

## Что сейчас сервер НЕ умеет

* Не может сохранять прогресс пользователей, и вообще принимать любые файлы (связоно с протоколом общения; подробнее ниже)
* Всё ещё не может самостоятельно создать файлик `<name>.CourseInfo` и папки пользователей (связано с ещё не до конца продуманной архитектурой БД)
* Не может паралельно работать более чем с одним клиентом (пока клиентов мало [< 100] это не проблема)

Однако (в защиту сервера), он разворачивается и работает))) А также он полностью независим от прошлой версии сервера (Cognitia repository)

## Что в планах

В порядке убывания приоритета:
1. Во всех клиентах надо переделать механизм общения с сервером. Писать в сокет напрямую никуда не годится. Необходимо добавть слой абстракции: обернуть всё общение с сервером в отдельный класс. Это упростит написание и тестирование протокола общения с сервером. Ну и вообще DRY)))
2. Протокол общения с сервером надо менять. Как минимум, держать открытый сокет долго - идея оооочень плохая. Можно ~~хочу~~ переделать на формат сообщений идейно (и только идейно) похожих на `HTTP 2.0`. Коды команд к серверу и ответов от него ~~хочу~~ надо менять кардинально. Они избыточны и не интуитивно понятны.
3. Продумать базу данных (сделать Entity–relationship model и т.д.). Правильно продуманная модель позволит:
   * Иметь несколько курсов
   * Иметь одних и тех же студентов (и менторов) на разных курсах
   * Понять, что я хочу от клиента администратора (человек, загружающий курсы на сервер, добавляющий студентов и т.д.)
4. Подумать, стоит ли упрощать процесс разворачивания сервера на машине (стоит ли написать скриптик, или что-то типо того)
5. Начать думать о аутентификации и авторизации пользователей
6. Очень аккуратно и сразу правильно (с вменяемым числом потоков) добавить асинхронность.

## Установка окружения и настройка

> **Всё делать в ветке `server` на последней стабильной версии!**

**коротко о файлах:**

* `server.py` - сам сервер
* `server_codes.py` - в этом файле записаны константы, которые используются при общении клиента с сервером
* `.env` - файл с переменными окружения (ЕГО НАДО ЗАПОЛНИТЬ!)
* `create_example_db.sql` (в `Examples/`) - можно скормить `sqlite3` и получить неплохой пример

Переходим в папку с сервером (`Sources/Server/.`)

Для начала рекомендую создать `python virtual environment` и активировать его

```bash
python3 -m venv .venv
source .venv/bin/activate
```

Теперь устанавливаем все необходимые пакеты

```bash
pip3 install -r requirements.txt
```

Теперь открываем `.env` файл и прописываем всё, что просят. В частности:

```bash
COURSE_DIR = 'path/to/cource' # например путь до dedCourse

SKILL_DIR = 'path/to/skillpack' # например путь до dedSkillPack

PROGRESS_DIR = 'path/to/users' # путь до папки с пользователями
```

Идём в `COURSE_DIR` и создаём там `<name>.CourseInfo` файлик

Папки пользользователей тоже нужно создать

> **Внимание!**
>
> В базе данных примера имена папок пользователей особенные!!! Они не совпадают с именами пользователей (для демонстрации возможности).
>
> Можно прочитать `create_example_db.sql` и посмотреть папочки.

На данном этапе можем запустить сервер

```bash
python3 server.py
```

Он будет слушать порт, который вы указали в `.env` и отдавать файлики зарегестрированным пользователям

Теперь:

1. Запускаем `StudentClient`
2. Подключаемся к серверу
3. Не обрашаем внимания на разорвавшееся соединение (это не баг, это пункт 2 планов).
4. Наслаждаемся курсом)

