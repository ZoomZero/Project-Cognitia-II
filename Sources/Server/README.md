# How to 'server.py'?

## Что сейчас умеет сервер

Всё, что он сейчас может, - это отдать подключившимуся пользователю курс, скиллпак и прогресс пользователя.

## Что сейчас сервер НЕ умеет

* Не может паралельно работать более чем с одним клиентом (пока клиентов мало [< 100] это не проблема)
* Не может иметь более чем одного пользователя (подробнее об этом ниже)
* Не может сохранять прогресс пользователей. Более того, не умеет ничего, кроме как отправлять курс.
* **НЕ МОЖЕТ** работать с `StudentClient` не из ветки `server`
  Это проблема №1. Почему-то, при передачи файлов, `StudentClient` дописывает в конец каждого файла `\x00`. И, в частности, при попытке окрыть курс, пытается открыть файл `path/to/some/sem1.CourseUnit\x00` и не может это сделать. Версия `StudentClient` из ветки `server` обрубает последний байт и таким 'костыльным' способом решает эту проблему.
  Это может быть вызвано:
  * Проблемой на стороне сервера (вполне вероятно, хотя я неоднократно пытался это отловить)
  * Проблемой в самом `StudentClient`. Я не знаю, как работает файловая система на Windows, возможно она позволяет корректно открыть файлы даже при наличии нуля в конце строки
  * Чем-то ещё, о чём я не догадываюсь

## Что в планах

В порядке убывания приоритета:

1. **!!!** Исправить баг с нулём, добавить поддержку нескольких пользователей.

2. Подумать над протоколом общения клиента с сервером. Я бы поменял порядок блоков в сообщении
3. Подумать как сделать нормально файл настроек. `.env` это неплохо, но в перспективе никуда не годится.
4.  Переделать систему хранения. Сваленные в кучу файлики это сдорово, но хочется придумать что-нибудь более упорядоченное (возможно KV-Storage или БД). Как минимум это позволит иметь несколько курсов и организованно их хранить.
5. Начать думать о аутентификации и авторизации пользователей
6.  Очень аккуратно и сразу правильно (с вменяемым числом потоков) добавить асинхронность.

## Установка окружения и настройка

**коротко о файлах:**

* server.py - сам сервер
* server_codes.py - в этом файле записаны константы, которые используются при общении клиента с сервером
* .env - файл с переменными окружения (ЕГО НАДО ЗАПОЛНИТЬ!)

Переходим в папку с сервером (`Sources/Server/.`)

Для начала рекомендую создать `python virtual environment` и активировать его

```bash
python3 -m venv .venv
source .venv/bin/activate
```

Теперь устанавливаем все зависимости (все проблемы с ними, которые возможно возникнут сейчас, будут решены в дальнейшем)

```bash
pip3 install -r requirements.txt
```

Теперь открываем .env файл и прописываем следующие переменные:

```bash
COURSE_DIR = 'path/to/cource' # например путь до dedCourse

SKILL_DIR = 'path/to/skillpack' # например путь до dedSkillPack

PROGRESS_DIR = 'path/to/USER' # Например App/Server/Username
```

**ВНИМАНИЕ**

> Сейчас python версия сервера не умеет сама создавать пользователей. Его необходимо откуда-то взять (например при помощи версии на C++). Более того,  на данном этапе (если вы видите это сообщение, то это так)  НЕ ВОЗМОЖНО иметь более чем одного пользователя.
>
> В PROGRESS_DIR должен быть записан путь до папки этого единственного пользователя

На данном этапе можем запустить сервер

```bash
python3 server.py
```

Он будет слушать порт 1917 и отдавать файлы выбранных course, skillpack и UserProgress.

Теперь:

1. Запускаем `StudentClient`
2. Подключаемся к серверу
3. Не обрашаем внимания на разорвавшееся соединение (это не баг, это фича: см пункт 2 в планах).
4. Наслаждаемся курсом)

